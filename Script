--[[
    uqi's farm v10 // THE MOBILE STANDARD
    Optimized for Delta, Fluxus, and Vega X
    Fixed: Non-Clip Door Distance + Raycast Offset
]]

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- --- CONFIG ---
getgenv().Uqi = {
    Active = false,
    FlameTool = "Flamethrower", -- Slot 1
    GunTool = "SilencerAR",     -- Slot 2
    VaultPos = Vector3.new(-617, -31, -285),
    StayDuration = 120,
    StartTime = 0
}

-- --- UI CONSTRUCTION (Sized for Mobile & Desktop) ---
local Screen = Instance.new("ScreenGui", LocalPlayer.PlayerGui); Screen.Name = "UqiV10"; Screen.ResetOnSpawn = false
local Main = Instance.new("Frame", Screen); Main.Size = UDim2.new(0, 300, 0, 280); Main.Position = UDim2.new(0.5, -150, 0.5, -140); Main.BackgroundColor3 = Color3.fromRGB(10, 10, 12); Main.BorderSizePixel = 0
Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 15)

local Grad = Instance.new("UIGradient", Main); Grad.Color = ColorSequence.new{ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 0)), ColorSequenceKeypoint.new(1, Color3.fromRGB(40, 0, 0))}
task.spawn(function() while true do game:GetService("TweenService"):Create(Grad, TweenInfo.new(4, Enum.EasingStyle.Linear), {Rotation = 360}):Play(); task.wait(4); Grad.Rotation = 0 end end)

local Title = Instance.new("TextLabel", Main); Title.Size = UDim2.new(1, 0, 0, 45); Title.Text = "uqi's farm v10"; Title.TextColor3 = Color3.new(1,1,1); Title.Font = "FredokaOne"; Title.TextSize = 24; Title.BackgroundTransparency = 1
local DC = Instance.new("TextLabel", Main); DC.Size = UDim2.new(1, 0, 0, 20); DC.Position = UDim2.new(0, 0, 0.16, 0); DC.Text = "discord: uk1sha"; DC.TextColor3 = Color3.fromRGB(150, 150, 150); DC.Font = "Gotham"; DC.TextSize = 12; DC.BackgroundTransparency = 1

local Console = Instance.new("ScrollingFrame", Main); Console.Size = UDim2.new(0.9, 0, 0, 100); Console.Position = UDim2.new(0.05, 0, 0.25, 0); Console.BackgroundColor3 = Color3.new(0, 0, 0); Console.CanvasSize = UDim2.new(0, 0, 15, 0); Console.ScrollBarThickness = 0
local List = Instance.new("UIListLayout", Console); List.Padding = UDim.new(0, 2)

local Status = Instance.new("TextLabel", Main); Status.Size = UDim2.new(1, 0, 0, 30); Status.Position = UDim2.new(0, 0, 0.65, 0); Status.Text = "SYSTEM: READY"; Status.TextColor3 = Color3.new(1,1,1); Status.Font = "Code"; Status.TextSize = 14; Status.BackgroundTransparency = 1

local StartBtn = Instance.new("TextButton", Main); StartBtn.Size = UDim2.new(0.8, 0, 0, 45); StartBtn.Position = UDim2.new(0.1, 0, 0.8, 0); StartBtn.Text = "START HEIST"; StartBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 35); StartBtn.TextColor3 = Color3.new(1,1,1); StartBtn.Font = "GothamBold"; Instance.new("UICorner", StartBtn)

-- --- UTILS ---
local function Log(msg, err)
    local t = Instance.new("TextLabel", Console); t.Size = UDim2.new(1, 0, 0, 15); t.Text = "> " .. msg; t.TextColor3 = err and Color3.new(1,0,0) or Color3.new(0.7,0.7,0.7); t.Font = "Code"; t.TextSize = 10; t.BackgroundTransparency = 1; t.TextXAlignment = "Left"
    Console.CanvasPosition = Vector2.new(0, 9999)
end

local function SmartEquip(name, slot)
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local tool = LocalPlayer.Backpack:FindFirstChild(name) or char:FindFirstChild(name)
    
    if tool then
        char.Humanoid:EquipTool(tool)
    else
        -- Mobile/Delta Hotkey Force
        local keys = {Enum.KeyCode.One, Enum.KeyCode.Two}
        VirtualInputManager:SendKeyEvent(true, keys[slot], false, game)
        task.wait(0.1)
        VirtualInputManager:SendKeyEvent(false, keys[slot], false, game)
    end
    task.wait(0.5)
    return char:FindFirstChildOfClass("Tool")
end

local function GetSafePosition(targetPart)
    -- This calculates a spot 6 studs away from the part's face so we aren't "inside" it
    local direction = (LocalPlayer.Character.HumanoidRootPart.Position - targetPart.Position).Unit
    return targetPart.Position + (direction * 6)
end

-- --- MAIN CORE ---
local function HeistProcess()
    getgenv().Uqi.StartTime = tick()
    local root = LocalPlayer.Character.HumanoidRootPart

    -- PHASE 1: VAULT
    Log("MOVING TO VAULT")
    root.CFrame = CFrame.new(getgenv().Uqi.VaultPos)
    task.wait(1)

    if SmartEquip(getgenv().Uqi.FlameTool, 1) then
        Log("BREACHING DOOR")
        root.CFrame = CFrame.new(root.Position, getgenv().Uqi.VaultPos)
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        task.wait(6)
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
    end

    -- PHASE 2: 2 MIN FARM
    Log("STARTING 2-MIN CYCLE")
    while (tick() - getgenv().Uqi.StartTime) < getgenv().Uqi.StayDuration and getgenv().Uqi.Active do
        local elapsed = math.floor(getgenv().Uqi.StayDuration - (tick() - getgenv().Uqi.StartTime))
        Status.Text = "HOPPING IN: " .. elapsed .. "s"

        -- Search for targets
        local target = nil
        for _, v in pairs(Workspace:GetDescendants()) do
            if (v.Name == "Door" or v.Name == "Safe" or v.Name == "VaultDoor") and v:IsA("BasePart") then
                if (v.Position - root.Position).Magnitude < 50 then
                    target = v; break
                end
            end
        end

        if target then
            -- Teleport to Safe Distance
            root.CFrame = CFrame.new(GetSafePosition(target), target.Position)
            if not LocalPlayer.Character:FindFirstChildOfClass("Tool") then SmartEquip(getgenv().Uqi.GunTool, 2) end
            VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        end

        -- CASH PICKUP (SPOOF)
        for _, cash in pairs(Workspace:GetChildren()) do
            if cash.Name == "DroppedCash" and (cash.Position - root.Position).Magnitude < 30 then
                Log("SPOOFING CASH")
                VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
                local old = root.CFrame
                root.CFrame = cash.CFrame
                task.wait(0.2)
                VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
                task.wait(0.05)
                VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
                task.wait(0.1)
                root.CFrame = old
            end
        end
        task.wait(0.5)
    end

    Log("STAY OVER. HOPPING.")
    -- Server Hop Logic
    local data = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"))
    for _, v in pairs(data.data) do
        if v.playing < v.maxPlayers and v.id ~= game.JobId then
            TeleportService:TeleportToPlaceInstance(game.PlaceId, v.id, LocalPlayer)
            break
        end
    end
end

-- --- BUTTON & DRAG ---
StartBtn.MouseButton1Click:Connect(function()
    if not getgenv().Uqi.Active then
        getgenv().Uqi.Active = true
        StartBtn.Text = "STOP"
        task.spawn(HeistProcess)
    else
        getgenv().Uqi.Active = false
        StartBtn.Text = "START HEIST"
    end
end)

-- Draggable Logic (Delta/Mobile Compatible)
local dragging, dragInput, dragStart, startPos
Main.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true; dragStart = input.Position; startPos = Main.Position
        input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
